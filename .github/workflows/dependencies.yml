name: Dependency Updates

on:
    schedule:
        - cron: '0 0 * * 1' # Run weekly on Mondays
    workflow_dispatch: null # Allow manual triggering

jobs:
    dependabot-auto-merge:
        name: Auto-merge Dependabot PRs
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
            contents: write
        steps:
            - uses: actions/checkout@v6

            - name: Dependabot metadata
              id: metadata
              uses: dependabot/fetch-metadata@v2
              with:
                  github-token: '${{ secrets.GITHUB_TOKEN }}'

            - name: Auto-merge Dependabot PRs for minor and patch updates
              if: ${{steps.metadata.outputs.update-type == 'version-update:semver-minor' || steps.metadata.outputs.update-type == 'version-update:semver-patch'}}
              run: gh pr merge --auto --merge "$PR_URL"
              env:
                  PR_URL: ${{github.event.pull_request.html_url}}
                  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

    npm-outdated:
        name: Check for outdated dependencies
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Set up Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Check for outdated dependencies
              run: npm outdated || true

            - name: Create issue for outdated dependencies
              if: ${{ failure() }}
              uses: JasonEtco/create-an-issue@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  filename: .github/ISSUE_TEMPLATE/outdated-dependencies.md
                  update_existing: true
